{% extends "base.html" %}
{% block title %}Detalle albarán {{ albaran.numero }} · Gestión de Inventario EVO{% endblock %}
{% block content %}
<div class="page-shell has-sidebar">
    <div class="stack">
        <section class="card" style="gap: 1rem;">
            <div class="page-header">
                <div>
                    <p class="eyebrow">Albarán</p>
                    <h2 style="margin: 0; color: var(--blue-700);">{{ albaran.numero }}</h2>
                    <p class="muted" style="margin: 0;">Proveedor <strong>{{ albaran.proveedor }}</strong> · Destino <strong>{{ albaran.fabrica }}</strong></p>
                    <p class="muted" style="margin: 0;">Recibido el {{ albaran.fecha.strftime('%d/%m/%Y %H:%M') }}</p>
                </div>
                <a class="btn-secondary" href="{{ url_for('albaranes') }}">← Volver al listado</a>
            </div>
            <form method="post" action="{{ url_for('actualizar_albaran', albaran_id=albaran.id) }}" class="form-grid" aria-label="Editar cabecera de albarán">
                <div class="stack">
                    <label for="numero">Número de albarán</label>
                    <input type="text" id="numero" name="numero" value="{{ albaran.numero }}" placeholder="Número de albarán" required />
                </div>
                <div class="stack">
                    <label for="proveedor">Proveedor</label>
                    <input type="text" id="proveedor" name="proveedor" value="{{ albaran.proveedor }}" placeholder="Proveedor" required />
                </div>
                <div class="pill-group" style="align-items: flex-end;">
                    <button type="submit" class="btn">Guardar cambios</button>
                </div>
            </form>
            <div class="stats-grid">
                <div class="stat-card">
                    <span>Líneas</span>
                    <strong>{{ albaran.lineas | length }}</strong>
                </div>
                <div class="stat-card">
                    <span>Unidades totales</span>
                    <strong>{{ totales.total_unidades }}</strong>
                </div>
                <div class="stat-card">
                    <span>Valor PVO</span>
                    <strong>{{ '€{:.2f}'.format(totales.total_pvo) }}</strong>
                </div>
                <div class="stat-card">
                    <span>Valor PVP</span>
                    <strong>{{ '€{:.2f}'.format(totales.total_pvp) }}</strong>
                </div>
            </div>
        </section>

        {% if albaran.lineas %}
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Código</th>
                            <th>Nombre</th>
                            <th>Tipo</th>
                            <th>Precio PVO</th>
                            <th>Precio PVP</th>
                            <th>Cantidad</th>
                            <th>Total PVO</th>
                            <th>Total PVP</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for linea in albaran.lineas %}
                            <tr>
                                <td>{{ linea.codigo }}</td>
                                <td>{{ linea.nombre }}</td>
                                <td>{{ linea.tipo or '-' }}</td>
                                <td>{{ '€{:.2f}'.format(linea.precio_pvo) }}</td>
                                <td>{{ '€{:.2f}'.format(linea.precio_pvp) }}</td>
                                <td>{{ linea.cantidad }}</td>
                                <td>{{ '€{:.2f}'.format(linea.precio_pvo * linea.cantidad) }}</td>
                                <td>{{ '€{:.2f}'.format(linea.precio_pvp * linea.cantidad) }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="empty-state">
                <p>Este albarán todavía no tiene líneas registradas.</p>
            </div>
        {% endif %}
    </div>

    <aside class="sidebar" aria-label="Selector rápido de albarán">
        <h3>Selector rápido</h3>
        <p class="muted">Cambiar entre albaranes sin salir del detalle.</p>
        <form method="get" class="stack">
            <label for="salto-albaran">Ir a otro albarán</label>
            <select id="salto-albaran" name="albaran_id" onchange="if(this.value) { window.location.href = this.value; }">
                <option value="" disabled selected>Selecciona albarán</option>
                {% for item in albaranes_resumen %}
                    <option value="{{ url_for('albaran_detalle', albaran_id=item.id) }}" {% if item.id == albaran.id %}selected{% endif %}>{{ item.numero }} · {{ item.proveedor }}</option>
                {% endfor %}
            </select>
        </form>
        <div class="stack">
            <p class="muted" style="margin: 0;">Accesos rápidos</p>
            <a class="btn-secondary" href="{{ url_for('lectura_codigos') }}">Ir a lectura de códigos</a>
            <a class="btn-secondary" href="{{ url_for('albaranes') }}">Listado de albaranes</a>
        </div>
    </aside>
</div>
{% endblock %}
