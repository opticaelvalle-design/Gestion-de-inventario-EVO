{% extends "base.html" %}
{% block title %}Pedido #{{ pedido.id }} · Gestión de Inventario EVO{% endblock %}
{% block content %}
<a class="button-link" href="{{ url_for('pedidos') }}">← Volver al listado</a>

<section>
    <h2 class="section-title">Pedido #{{ pedido.id }}</h2>
    <div class="stats-grid">
        <div class="stat-card">
            <span>Cliente</span>
            <strong>{{ pedido.cliente }}</strong>
        </div>
        <div class="stat-card">
            <span>Fecha</span>
            <strong>{{ pedido.fecha.strftime('%d/%m/%Y %H:%M') }}</strong>
        </div>
        <div class="stat-card">
            <span>Estado</span>
            <strong>{{ pedido.estado }}</strong>
        </div>
        <div class="stat-card">
            <span>Unidades solicitadas</span>
            <strong>{{ total_solicitado }}</strong>
        </div>
        <div class="stat-card">
            <span>Unidades recibidas</span>
            <strong>{{ total_recibido }}</strong>
        </div>
        <div class="stat-card">
            <span>Unidades pendientes</span>
            <strong>{{ total_pendiente }}</strong>
        </div>
    </div>
    {% if pedido.notas %}
    <p><strong>Notas:</strong> {{ pedido.notas }}</p>
    {% endif %}
</section>

<section>
    <h3 class="section-title">Líneas del pedido</h3>
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>PEDIDO</th>
                    <th>CLIENTE</th>
                    <th>CODIGO</th>
                    <th>DESCRIPCIÓN</th>
                    <th>CANTIDAD PEDIDA</th>
                    <th>CANTIDAD RECIBIDA</th>
                    <th>CANTIDAD PENDIENTE</th>
                    <th>GAVETA ASIGNADA</th>
                    <th>FECHA</th>
                    <th>ACCIONES</th>
                </tr>
            </thead>
            <tbody>
                {% for linea in pedido.lineas %}
                <tr>
                    <td>#{{ pedido.id }}</td>
                    <td>{{ pedido.cliente }}</td>
                    <td>{{ linea.codigo }}</td>
                    <td>{{ linea.descripcion }}</td>
                    <td>{{ linea.cantidad_pedida }}</td>
                    <td>{{ linea.cantidad_recibida }}</td>
                    <td>{{ linea.cantidad_pendiente }}</td>
                    <td>
                        {% set clave = (pedido.id, linea.codigo.lower()) %}
                        {% set asignacion = asignaciones.get(clave) %}
                        {% if asignacion %}
                            <div style="display: flex; flex-direction: column; gap: 0.15rem;">
                                <strong>{{ asignacion.gaveta.nombre }}</strong>
                                <small>Unidades registradas: {{ asignacion.unidades }}</small>
                            </div>
                        {% else %}
                            <em>Sin asignar</em>
                        {% endif %}
                    </td>
                    <td>{{ pedido.fecha.strftime('%d/%m/%Y') }}</td>
                    <td>
                        {% if gavetas_existentes %}
                            <form method="post" action="{{ url_for('asignar_gaveta_pedido', pedido_id=pedido.id) }}" class="action-buttons">
                                <input type="hidden" name="codigo" value="{{ linea.codigo }}" />
                                <label for="gaveta_{{ linea.codigo }}" style="font-size: 0.9rem;">Asignar gaveta</label>
                                <select name="gaveta_nombre" id="gaveta_{{ linea.codigo }}">
                                    <option value="" disabled {% if not asignacion %}selected{% endif %}>Selecciona gaveta</option>
                                    {% for gaveta in gavetas_existentes %}
                                        <option value="{{ gaveta.nombre }}" {% if asignacion and gaveta.nombre == asignacion.gaveta.nombre %}selected{% endif %}>{{ gaveta.nombre }}</option>
                                    {% endfor %}
                                </select>
                                <button type="submit" style="padding: 0.45rem 0.65rem;">Guardar</button>
                            </form>
                        {% else %}
                            <small>No hay gavetas creadas.</small>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>
{% endblock %}