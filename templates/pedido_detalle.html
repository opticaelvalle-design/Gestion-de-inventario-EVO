{% extends "base.html" %}
{% block title %}Pedido #{{ pedido.id }} · Gestión de Inventario EVO{% endblock %}
{% block content %}
<div class="section-header" style="margin-bottom: 1rem;">
    <a class="button-link" href="{{ url_for('pedidos') }}" style="display: inline-flex; align-items: center; gap: 0.35rem;">← Volver al listado</a>
    <div class="pill-group">
        {% set estado = pedido.estado.lower() %}
        <span class="badge {% if 'pend' in estado %}badge-warning{% elif 'recib' in estado %}badge-success{% else %}badge-neutral{% endif %}">Estado: {{ pedido.estado }}</span>
        <span class="badge badge-info">Pedido #{{ pedido.id }}</span>
    </div>
</div>

<section class="stacked-panel">
    <div class="section-header" style="align-items: flex-start;">
        <div>
            <h2 class="section-title" style="margin: 0;">Pedido #{{ pedido.id }}</h2>
            <p class="muted" style="margin: 0.35rem 0 0;">Resumen con totales y estado actualizado del pedido.</p>
        </div>
        <div class="pill-group">
            <span class="badge badge-neutral">{{ pedido.fecha.strftime('%d/%m/%Y %H:%M') }}</span>
            <span class="badge badge-info">{{ pedido.cliente }}</span>
        </div>
    </div>
    <div class="stats-grid">
        <div class="stat-card">
            <span>Cliente</span>
            <strong>{{ pedido.cliente }}</strong>
        </div>
        <div class="stat-card">
            <span>Fecha</span>
            <strong>{{ pedido.fecha.strftime('%d/%m/%Y %H:%M') }}</strong>
        </div>
        <div class="stat-card">
            <span>Estado</span>
            <strong>{{ pedido.estado }}</strong>
        </div>
        <div class="stat-card">
            <span>Unidades solicitadas</span>
            <strong>{{ total_solicitado }}</strong>
        </div>
        <div class="stat-card">
            <span>Unidades recibidas</span>
            <strong>{{ total_recibido }}</strong>
        </div>
        <div class="stat-card">
            <span>Unidades pendientes</span>
            <strong>{{ total_pendiente }}</strong>
        </div>
    </div>
    {% if pedido.notas %}
    <div class="stacked-panel" style="padding: 1.25rem; box-shadow: none; border: 1px dashed #dcdde1;">
        <h4 class="panel-title">Notas del pedido</h4>
        <p class="panel-content" style="margin: 0;">{{ pedido.notas }}</p>
    </div>
    {% endif %}
</section>

<section>
    <div class="section-header" style="margin-bottom: 0.5rem;">
        <h3 class="section-title" style="margin: 0;">Líneas del pedido</h3>
        <p class="muted" style="margin: 0;">Gestiona asignaciones y confirma la recepción línea a línea.</p>
    </div>
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Pedido</th>
                    <th>Cliente</th>
                    <th>Código</th>
                    <th>Descripción</th>
                    <th>Pedida</th>
                    <th>Recibida</th>
                    <th>Pendiente</th>
                    <th>Gaveta asignada</th>
                    <th>Fecha</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for linea in pedido.lineas %}
                {% set clave = (pedido.id, linea.codigo.lower()) %}
                {% set asignacion = asignaciones.get(clave) %}
                <tr class="striped {% if linea.cantidad_pendiente > 0 %}row-warning{% else %}row-positive{% endif %}">
                    <td>#{{ pedido.id }}</td>
                    <td>{{ pedido.cliente }}</td>
                    <td>{{ linea.codigo }}</td>
                    <td>{{ linea.descripcion }}</td>
                    <td>{{ linea.cantidad_pedida }}</td>
                    <td>{{ linea.cantidad_recibida }}</td>
                    <td>{{ linea.cantidad_pendiente }}</td>
                    <td>
                        {% if asignacion %}
                            <div style="display: flex; flex-direction: column; gap: 0.15rem;">
                                <strong>{{ asignacion.gaveta.nombre }}</strong>
                                <small>Unidades registradas: {{ asignacion.unidades }}</small>
                            </div>
                        {% else %}
                            <em>Sin asignar</em>
                        {% endif %}
                    </td>
                    <td>{{ pedido.fecha.strftime('%d/%m/%Y') }}</td>
                    <td>
                        {% if gavetas_existentes %}
                            <form method="post" action="{{ url_for('asignar_gaveta_pedido', pedido_id=pedido.id) }}" style="display: grid; gap: 0.25rem; align-items: center;">
                                <input type="hidden" name="codigo" value="{{ linea.codigo }}" />
                                <label for="gaveta_{{ linea.codigo }}" style="font-size: 0.9rem; font-weight: 600;">Asignar gaveta</label>
                                <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                                    <select name="gaveta_nombre" id="gaveta_{{ linea.codigo }}">
                                        <option value="" disabled {% if not asignacion %}selected{% endif %}>Selecciona gaveta</option>
                                        {% for gaveta in gavetas_existentes %}
                                            <option value="{{ gaveta.nombre }}" {% if asignacion and gaveta.nombre == asignacion.gaveta.nombre %}selected{% endif %}>{{ gaveta.nombre }}</option>
                                        {% endfor %}
                                    </select>
                                    <button type="submit" class="button-link" style="display: inline-flex; align-items: center; padding: 0.4rem 0.65rem;">Guardar</button>
                                </div>
                            </form>
                        {% else %}
                            <small>No hay gavetas creadas.</small>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>
{% endblock %}