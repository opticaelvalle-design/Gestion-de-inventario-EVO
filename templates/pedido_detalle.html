{% extends "base.html" %}
{% block title %}Pedido #{{ pedido.id }} ¬∑ Gesti√≥n de Inventario EVO{% endblock %}
{% block content %}
<div class="section-header" style="margin-bottom: 1rem;">
    <a class="button-link" href="{{ url_for('pedidos') }}" style="display: inline-flex; align-items: center; gap: 0.35rem;">‚Üê Volver al listado</a>
    <div class="pill-group" style="align-items: center; gap: 0.5rem;">
        {% set estado = pedido.estado.lower() %}
        <span class="badge {% if 'pend' in estado %}badge-warning{% elif 'recib' in estado %}badge-success{% else %}badge-neutral{% endif %}">Estado: {{ pedido.estado }}</span>
        <span class="badge badge-info">Pedido #{{ pedido.id }}</span>
        <button id="toggle-editar" type="button" class="button-link" style="display: inline-flex; align-items: center; gap: 0.35rem;">
            ‚úèÔ∏è Editar pedido
        </button>
    </div>
</div>

<section class="stacked-panel">
    <div class="section-header" style="align-items: flex-start;">
        <div>
            <h2 class="section-title" style="margin: 0;">Pedido #{{ pedido.id }}</h2>
            <p class="muted" style="margin: 0.35rem 0 0;">Resumen con totales y estado actualizado del pedido.</p>
        </div>
        <div class="pill-group">
            <span class="badge badge-neutral">{{ pedido.nombre }}</span>
            <span class="badge badge-neutral">{{ pedido.fecha.strftime('%d/%m/%Y %H:%M') }}</span>
            <span class="badge badge-info">{{ pedido.cliente }}</span>
        </div>
    </div>
    <div class="stats-grid">
        <div class="stat-card">
            <span>Nombre</span>
            <strong>{{ pedido.nombre }}</strong>
        </div>
        <div class="stat-card">
            <span>Cliente</span>
            <strong>{{ pedido.cliente }}</strong>
        </div>
        <div class="stat-card">
            <span>Fecha</span>
            <strong>{{ pedido.fecha.strftime('%d/%m/%Y %H:%M') }}</strong>
        </div>
        <div class="stat-card">
            <span>Estado</span>
            <strong>{{ pedido.estado }}</strong>
        </div>
        <div class="stat-card">
            <span>Unidades solicitadas</span>
            <strong>{{ total_solicitado }}</strong>
        </div>
        <div class="stat-card">
            <span>Unidades recibidas</span>
            <strong>{{ total_recibido }}</strong>
        </div>
        <div class="stat-card">
            <span>Unidades pendientes</span>
            <strong>{{ total_pendiente }}</strong>
        </div>
    </div>
    {% if pedido.notas %}
    <div class="stacked-panel" style="padding: 1.25rem; box-shadow: none; border: 1px dashed #dcdde1;">
        <h4 class="panel-title">Notas del pedido</h4>
        <p class="panel-content" style="margin: 0;">{{ pedido.notas }}</p>
    </div>
    {% endif %}
</section>

<section id="panel-edicion" class="stacked-panel" style="display: none; margin-top: 1rem;">
    <div class="section-header" style="margin-bottom: 0.5rem;">
        <h3 class="section-title" style="margin: 0;">Editar pedido</h3>
        <p class="muted" style="margin: 0;">Actualiza los datos generales del pedido.</p>
    </div>
    <form method="post" action="{{ url_for('editar_pedido', pedido_id=pedido.id) }}" class="form-grid" style="gap: 1rem;">
        <div>
            <label for="nombre">Nombre del pedido</label>
            <input type="text" id="nombre" name="nombre" value="{{ pedido.nombre }}" required />
        </div>
        <div>
            <label for="cliente">Cliente</label>
            <input type="text" id="cliente" name="cliente" value="{{ pedido.cliente }}" required />
        </div>
        <div>
            <label for="fecha">Fecha</label>
            <input type="datetime-local" id="fecha" name="fecha" value="{{ pedido.fecha.strftime('%Y-%m-%dT%H:%M') }}" required />
        </div>
        <div>
            <label for="estado">Estado</label>
            <select id="estado" name="estado" required>
                {% set estado_normalizado = pedido.estado.lower() %}
                <option value="Pendiente" {% if 'pend' in estado_normalizado %}selected{% endif %}>Pendiente</option>
                <option value="Parcial" {% if 'parc' in estado_normalizado %}selected{% endif %}>Parcial</option>
                <option value="Completado" {% if 'compl' in estado_normalizado %}selected{% endif %}>Completado</option>
                <option value="Recibido" {% if 'recib' in estado_normalizado %}selected{% endif %}>Recibido</option>
            </select>
        </div>
        <div style="grid-column: 1 / -1;">
            <label for="notas">Notas</label>
            <textarea id="notas" name="notas" rows="3" placeholder="A√±ade detalles o recordatorios para el equipo.">{{ pedido.notas or '' }}</textarea>
        </div>
        <div style="grid-column: 1 / -1; display: flex; gap: 0.75rem; justify-content: flex-end;">
            <button type="button" id="cancelar-edicion" class="button-link" style="background: #f5f6fa; color: #2f3640;">Cancelar</button>
            <button type="submit" class="button-link" style="display: inline-flex; align-items: center; gap: 0.35rem;">üíæ Guardar cambios</button>
        </div>
    </form>
</section>

<section>
    <div class="section-header" style="margin-bottom: 0.5rem;">
        <h3 class="section-title" style="margin: 0;">L√≠neas del pedido</h3>
        <p class="muted" style="margin: 0;">Consulta las unidades solicitadas, su estado y la ubicaci√≥n asignada.</p>
    </div>
    <form method="post" action="{{ url_for('agregar_linea_pedido', pedido_id=pedido.id) }}" class="stacked-panel" style="margin-bottom: 1rem;">
        <div class="section-header" style="margin-bottom: 0.5rem;">
            <h4 class="section-title" style="margin: 0;">A√±adir nueva l√≠nea</h4>
            <p class="muted" style="margin: 0;">Incluye art√≠culos adicionales en este pedido.</p>
        </div>
        <div class="form-grid" style="gap: 1rem;">
            <div>
                <label for="codigo">C√≥digo</label>
                <input type="text" id="codigo" name="codigo" placeholder="Referencia del art√≠culo" required />
            </div>
            <div>
                <label for="descripcion">Descripci√≥n</label>
                <input type="text" id="descripcion" name="descripcion" placeholder="Nombre del art√≠culo" required />
            </div>
            <div>
                <label for="cantidad">Cantidad</label>
                <input type="number" id="cantidad" name="cantidad" min="1" step="1" required />
            </div>
        </div>
        <div style="display: flex; justify-content: flex-end; gap: 0.75rem;">
            <button type="submit" class="button-link" style="display: inline-flex; align-items: center; gap: 0.35rem;">‚ûï A√±adir l√≠nea</button>
        </div>
    </form>
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Unidades</th>
                    <th>Estado</th>
                    <th>Gaveta asignada</th>
                    <th>Fecha</th>
                </tr>
            </thead>
            <tbody>
                {% for linea in pedido.lineas %}
                {% set clave = (pedido.id, linea.codigo.lower()) %}
                {% set asignacion = asignaciones.get(clave) %}
                {% set estado_linea = 'Pendiente' if linea.cantidad_recibida == 0 else ('Parcial' if linea.cantidad_pendiente > 0 else 'Recibido') %}
                <tr class="striped {% if linea.cantidad_pendiente > 0 %}row-warning{% else %}row-positive{% endif %}">
                    <td>
                        <div style="display: flex; flex-direction: column; gap: 0.2rem;">
                            <strong>{{ linea.codigo }}</strong>
                            <span class="muted">{{ linea.descripcion }}</span>
                        </div>
                    </td>
                    <td>
                        <div style="display: grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap: 0.5rem; align-items: center;">
                            <div style="text-align: center;">
                                <small class="muted" style="display: block;">Pedida</small>
                                <strong>{{ linea.cantidad_pedida }}</strong>
                            </div>
                            <div style="text-align: center;">
                                <small class="muted" style="display: block;">Recibida</small>
                                <strong>{{ linea.cantidad_recibida }}</strong>
                            </div>
                            <div style="text-align: center;">
                                <small class="muted" style="display: block;">Pendiente</small>
                                <strong>{{ linea.cantidad_pendiente }}</strong>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="badge {% if estado_linea == 'Recibido' %}badge-success{% elif estado_linea == 'Parcial' %}badge-warning{% else %}badge-neutral{% endif %}">{{ estado_linea }}</span>
                    </td>
                    <td>
                        {% if asignacion %}
                            <div style="display: flex; flex-direction: column; gap: 0.15rem;">
                                <strong>{{ asignacion.gaveta.nombre }}</strong>
                                <small>Unidades registradas: {{ asignacion.unidades }}</small>
                            </div>
                        {% else %}
                            <em>Sin asignar</em>
                        {% endif %}
                    </td>
                    <td>{{ pedido.fecha.strftime('%d/%m/%Y') }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>
<script>
    const toggleBtn = document.getElementById('toggle-editar');
    const cancelBtn = document.getElementById('cancelar-edicion');
    const panelEdicion = document.getElementById('panel-edicion');

    function togglePanel() {
        const visible = panelEdicion.style.display === 'block';
        panelEdicion.style.display = visible ? 'none' : 'block';
    }

    toggleBtn?.addEventListener('click', togglePanel);
    cancelBtn?.addEventListener('click', togglePanel);
</script>
{% endblock %}