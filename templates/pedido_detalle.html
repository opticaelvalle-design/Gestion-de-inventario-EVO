{% extends "base.html" %}
{% block title %}Pedido #{{ pedido.id }} · Gestión de Inventario EVO{% endblock %}
{% block content %}
<a class="button-link" href="{{ url_for('pedidos') }}">← Volver al listado</a>

<section>
    <h2 class="section-title">Pedido #{{ pedido.id }}</h2>
    <div class="stats-grid">
        <div class="stat-card">
            <span>Cliente</span>
            <strong>{{ pedido.cliente }}</strong>
        </div>
        <div class="stat-card">
            <span>Fecha</span>
            <strong>{{ pedido.fecha.strftime('%d/%m/%Y %H:%M') }}</strong>
        </div>
        <div class="stat-card">
            <span>Estado</span>
            <strong>{{ pedido.estado }}</strong>
        </div>
        <div class="stat-card">
            <span>Unidades solicitadas</span>
            <strong>{{ total_solicitado }}</strong>
        </div>
        <div class="stat-card">
            <span>Unidades recibidas</span>
            <strong>{{ total_recibido }}</strong>
        </div>
        <div class="stat-card">
            <span>Unidades pendientes</span>
            <strong>{{ total_pendiente }}</strong>
        </div>
    </div>
    {% if pedido.notas %}
    <p><strong>Notas:</strong> {{ pedido.notas }}</p>
    {% endif %}
</section>

<section class="card" style="margin-top: 1.5rem; gap: 0.75rem;">
    <div>
        <h3 style="margin: 0;">Actualizar nombre del pedido</h3>
        <p style="margin: 0; color: #57606f;">Cambia el identificador visible del pedido en pantalla.</p>
    </div>
    <form method="post" action="{{ url_for('actualizar_pedido', pedido_id=pedido.id) }}" style="display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: flex-end; margin-top: 0.5rem;">
        <div style="flex: 1 1 260px; min-width: 240px;">
            <label for="cliente">Nombre del pedido</label>
            <input type="text" id="cliente" name="cliente" value="{{ pedido.cliente }}" required />
        </div>
        <button type="submit">Guardar cambios</button>
    </form>
</section>

<section class="card" style="margin-top: 1.5rem; gap: 1rem;">
    <div>
        <h3 style="margin: 0;">Añadir nueva línea</h3>
        <p style="margin: 0; color: #57606f;">Registra productos adicionales directamente en este pedido.</p>
    </div>
    <form method="post" action="{{ url_for('agregar_linea_pedido', pedido_id=pedido.id) }}" class="form-grid" style="gap: 0.75rem; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
        <div>
            <label for="codigo">Código</label>
            <input type="text" id="codigo" name="codigo" placeholder="Ej. ABC123" required />
        </div>
        <div>
            <label for="descripcion">Descripción</label>
            <input type="text" id="descripcion" name="descripcion" placeholder="Producto" required />
        </div>
        <div>
            <label for="cantidad_pedida">Cantidad pedida</label>
            <input type="number" id="cantidad_pedida" name="cantidad_pedida" min="1" placeholder="Ej. 50" required />
        </div>
        <div>
            <label for="cantidad_recibida">Cantidad recibida (opcional)</label>
            <input type="number" id="cantidad_recibida" name="cantidad_recibida" min="0" value="0" />
        </div>
        <div style="align-self: flex-end;">
            <button type="submit">Añadir línea</button>
        </div>
    </form>
</section>

<section>
    <h3 class="section-title">Líneas del pedido</h3>
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>PEDIDO</th>
                    <th>CLIENTE</th>
                    <th>CODIGO</th>
                    <th>DESCRIPCIÓN</th>
                    <th>CANTIDAD PEDIDA</th>
                    <th>CANTIDAD RECIBIDA</th>
                    <th>CANTIDAD PENDIENTE</th>
                    <th>FECHA</th>
                    <th>ACCIONES</th>
                </tr>
            </thead>
            <tbody>
                {% for linea in pedido.lineas %}
                <tr>
                    <td>#{{ pedido.id }}</td>
                    <td>{{ pedido.cliente }}</td>
                    <td>{{ linea.codigo }}</td>
                    <td>{{ linea.descripcion }}</td>
                    <td>{{ linea.cantidad_pedida }}</td>
                    <td>{{ linea.cantidad_recibida }}</td>
                    <td>{{ linea.cantidad_pendiente }}</td>
                    <td>{{ pedido.fecha.strftime('%d/%m/%Y') }}</td>
                    <td>
                        <div class="line-actions">
                            <form method="post" action="{{ url_for('editar_linea_pedido', pedido_id=pedido.id, codigo=linea.codigo) }}" class="line-actions__form">
                                <input type="hidden" name="codigo" value="{{ linea.codigo }}" />
                                <label class="sr-only" for="descripcion_{{ linea.codigo }}">Descripción</label>
                                <input type="text" id="descripcion_{{ linea.codigo }}" name="descripcion" value="{{ linea.descripcion }}" required />
                                <label class="sr-only" for="cantidad_pedida_{{ linea.codigo }}">Cantidad pedida</label>
                                <input type="number" id="cantidad_pedida_{{ linea.codigo }}" name="cantidad_pedida" min="1" value="{{ linea.cantidad_pedida }}" required />
                                <label class="sr-only" for="cantidad_recibida_{{ linea.codigo }}">Cantidad recibida</label>
                                <input type="number" id="cantidad_recibida_{{ linea.codigo }}" name="cantidad_recibida" min="0" max="{{ linea.cantidad_pedida }}" value="{{ linea.cantidad_recibida }}" required />
                                <button type="submit" class="button-link">Editar</button>
                            </form>
                            <form method="post" action="{{ url_for('eliminar_linea_pedido', pedido_id=pedido.id, codigo=linea.codigo) }}" onsubmit="return confirm('¿Seguro que quieres eliminar la línea {{ linea.codigo }}?');">
                                <button type="submit" class="button-link" style="background-color: #b3261e; color: white;">Eliminar</button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</section>
{% endblock %}