{% extends "base.html" %}
{% block title %}Lectura de códigos · Gestión de Inventario EVO{% endblock %}
{% block content %}
<section class="card" style="gap: 1.25rem;">
    <div>
        <h2>Lectura de códigos</h2>
        <p>Escanea o introduce manualmente un código para registrar la recepción unidad a unidad.</p>
    </div>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(230px, 1fr)); gap: 0.75rem; align-items: end;">
        <div class="stat-card" style="gap: 0.35rem;">
            <span>Albarán en curso</span>
            {% if albaran_activo %}
                <strong>{{ albaran_activo.numero }}</strong>
                <small style="color: #353b48;">{{ albaran_activo.proveedor }} · {{ albaran_activo.fabrica }}</small>
            {% else %}
                <strong>Ninguno</strong>
                <small style="color: #c23616; font-weight: 600;">Selecciona o crea un albarán antes de leer.</small>
            {% endif %}
        </div>
        <button type="button" id="abrir-modal-albaran" style="height: 100%;">Crear albarán nuevo</button>
        <form method="post" style="gap: 0.35rem;">
            <label for="albaran_id">Elegir albarán existente</label>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <select name="albaran_id" id="albaran_id" style="flex: 1; padding: 0.55rem 0.75rem;">
                    <option value="" disabled selected>Selecciona un albarán</option>
                    {% for albaran in albaranes %}
                        <option value="{{ albaran.id }}">{{ albaran.numero }} · {{ albaran.proveedor }}</option>
                    {% endfor %}
                </select>
                <input type="hidden" name="accion" value="seleccionar_albaran" />
                <button type="submit">Usar</button>
            </div>
        </form>
        {% if albaran_activo %}
            <form method="post" style="gap: 0.35rem;">
                <input type="hidden" name="accion" value="detener_albaran" />
                <button type="submit" style="background-color: #f6b93b; color: #2d3436; border-color: #f6b93b;">Dejar de leer en el albarán</button>
            </form>
        {% endif %}
    </div>
    <form method="post" style="display: flex; flex-direction: column; gap: 0.5rem;">
        <label for="codigo">Código de barras</label>
        <input type="text" name="codigo" id="codigo" value="{{ codigo }}" placeholder="Ej. ABC123" autofocus autocomplete="off" />
        <input type="hidden" name="accion" value="leer" />
        <button type="submit">Registrar recepción</button>
    </form>
    <form method="post" style="align-self: flex-start;">
        <input type="hidden" name="accion" value="deshacer" />
        <button type="submit" style="background-color: #c23616; color: #fff; border-color: #c23616;">Deshacer última lectura</button>
    </form>
    {% if resultado %}
        <div class="stat-card">
            <span>Última lectura</span>
            <strong>Pedido #{{ resultado.pedido_id }} · {{ resultado.cliente }}</strong>
            <p>
                Código {{ resultado.linea.codigo }} · Recibidas {{ resultado.linea.cantidad_recibida }} /
                {{ resultado.linea.cantidad_pedida }} · Pendientes {{ resultado.linea.cantidad_pendiente }}
            </p>
            {% if resultado.albaran %}
                <p>
                    Albarán: <strong>{{ resultado.albaran }}</strong>
                    {% if resultado.linea_albaran %}
                        · Unidades en albarán: {{ resultado.linea_albaran.cantidad }}
                    {% endif %}
                </p>
            {% endif %}
            {% if resultado.gaveta %}
                <p>
                    Ubicación asignada:
                    <strong>{{ resultado.gaveta }}</strong>
                    · Unidades almacenadas en la gaveta: {{ resultado.unidades_gaveta }}
                </p>
                {% if resultado.gaveta_creada %}
                    <p style="color: #0097e6; font-weight: 600;">
                        Se creó una nueva gaveta para este pedido y código.
                    </p>
                {% endif %}
            {% endif %}
            {% if resultado.deshacer %}
                <p style="color: #c23616; font-weight: 600;">Se revirtió la última lectura.</p>
            {% elif resultado.completado %}
                <p style="color: #009432; font-weight: 600;">¡Línea completada!</p>
            {% endif %}
        </div>
    {% endif %}
</section>

<h2 class="section-title">Líneas con unidades pendientes</h2>
{% if lineas_pendientes %}
    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th>Pedido</th>
                    <th>Cliente</th>
                    <th>Código</th>
                    <th>Descripción</th>
                    <th>Pedidas</th>
                    <th>Recibidas</th>
                    <th>Pendientes</th>
                    <th>Fecha</th>
                </tr>
            </thead>
            <tbody>
                {% for linea in lineas_pendientes %}
                    <tr>
                        <td><a href="{{ url_for('pedido_detalle', pedido_id=linea.pedido_id) }}" class="button-link" style="padding: 0.35rem 0.65rem; font-size: 0.85rem;">#{{ linea.pedido_id }}</a></td>
                        <td>{{ linea.cliente }}</td>
                        <td>{{ linea.codigo }}</td>
                        <td>{{ linea.descripcion }}</td>
                        <td>{{ linea.cantidad_pedida }}</td>
                        <td>{{ linea.cantidad_recibida }}</td>
                        <td>{{ linea.cantidad_pendiente }}</td>
                        <td>{{ linea.fecha.strftime('%d/%m/%Y') }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% else %}
    <div class="empty-state">
        <p>No hay unidades pendientes en ningún pedido.</p>
    </div>
{% endif %}

<h2 class="section-title">Gavetas activas</h2>
{% if gavetas_activas %}
    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th>Gaveta</th>
                    <th>Pedido</th>
                    <th>Cliente</th>
                    <th>Código</th>
                    <th>Descripción</th>
                    <th>Unidades almacenadas</th>
                </tr>
            </thead>
            <tbody>
                {% for gaveta in gavetas_activas %}
                    <tr>
                        <td>{{ gaveta.nombre }}</td>
                        <td>#{{ gaveta.pedido_id }}</td>
                        <td>{{ gaveta.cliente }}</td>
                        <td>{{ gaveta.codigo }}</td>
                        <td>{{ gaveta.descripcion }}</td>
                        <td>{{ gaveta.unidades }}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% else %}
    <div class="empty-state">
        <p>Todavía no se han asignado gavetas a los pedidos.</p>
    </div>
{% endif %}

<div id="modal-crear-albaran" style="position: fixed; inset: 0; background: rgba(0, 0, 0, 0.3); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 1rem;">
    <div style="background: #fff; border-radius: 10px; padding: 1.25rem; max-width: 480px; width: 100%; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12); display: grid; gap: 0.75rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; gap: 0.5rem;">
            <h3 style="margin: 0;">Crear albarán</h3>
            <button type="button" id="cerrar-modal-albaran" style="background: none; color: #2d3436; border: none; font-size: 1.1rem; cursor: pointer; padding: 0.25rem 0.5rem;">✕</button>
        </div>
        <form method="post" id="form-crear-albaran" style="display: grid; gap: 0.75rem;">
            <div style="display: grid; gap: 0.35rem;">
                <label for="numero_albaran">Nombre o número</label>
                <input type="text" id="numero_albaran" name="numero" value="{{ numero_sugerido }}" placeholder="Ej. {{ numero_sugerido }}" />
            </div>
            <div style="display: grid; gap: 0.35rem;">
                <label for="proveedor_albaran">Proveedor</label>
                <input type="text" id="proveedor_albaran" name="proveedor" placeholder="Nombre del proveedor" />
            </div>
            <input type="hidden" name="accion" value="nuevo_albaran" />
            <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                <button type="button" id="cancelar-modal-albaran" style="background: #dcdde1; color: #2d3436; border-color: #dcdde1;">Cancelar</button>
                <button type="submit">Crear albarán</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const codigoInput = document.getElementById('codigo');
    if (codigoInput) {
        codigoInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                codigoInput.form.submit();
            }
        });
    }

    const modal = document.getElementById('modal-crear-albaran');
    const abrirModalBtn = document.getElementById('abrir-modal-albaran');
    const cerrarModalBtn = document.getElementById('cerrar-modal-albaran');
    const cancelarModalBtn = document.getElementById('cancelar-modal-albaran');
    const numeroAlbaranInput = document.getElementById('numero_albaran');

    const abrirModal = () => {
        if (modal) {
            modal.style.display = 'flex';
            if (numeroAlbaranInput) {
                numeroAlbaranInput.focus();
                numeroAlbaranInput.select();
            }
        }
    };

    const cerrarModal = () => {
        if (modal) {
            modal.style.display = 'none';
        }
    };

    if (abrirModalBtn) abrirModalBtn.addEventListener('click', abrirModal);
    if (cerrarModalBtn) cerrarModalBtn.addEventListener('click', cerrarModal);
    if (cancelarModalBtn) cancelarModalBtn.addEventListener('click', cerrarModal);

    if (modal) {
        modal.addEventListener('click', (event) => {
            if (event.target === modal) {
                cerrarModal();
            }
        });
    }
</script>
{% endblock %}
