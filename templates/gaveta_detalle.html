{% extends "base.html" %}
{% block title %}{{ ubicacion.nombre }} · Gestión de Inventario EVO{% endblock %}
{% block content %}
<div style="display: flex; justify-content: space-between; gap: 1rem; align-items: center; flex-wrap: wrap; margin-bottom: 1rem;">
    <a href="{{ url_for('crear_gavetas') }}" class="button-link" style="display: inline-flex; align-items: center; gap: 0.35rem;">
        ← Volver a gavetas
    </a>
    <form method="post" action="{{ url_for('actualizar_estado_gaveta', nombre=ubicacion.nombre) }}" class="inline-form" style="display: inline-flex; align-items: center; gap: 0.5rem;">
        <label for="estado" style="margin: 0; font-weight: 600;">Estado de gaveta</label>
        <select id="estado" name="estado">
            <option value="Abierta" {% if ubicacion.estado.lower() == 'abierta' %}selected{% endif %}>Abierta</option>
            <option value="Facturada" {% if ubicacion.estado.lower() == 'facturada' %}selected{% endif %}>Facturada</option>
        </select>
        <button type="submit" class="button-link">Actualizar</button>
    </form>
</div>
<section class="card" style="gap: 1rem;">
    <div>
        <h2>{{ ubicacion.nombre }}</h2>
        <p>{{ ubicacion.tipo }} · Estado: {{ ubicacion.estado }}</p>
        <p>Dada de alta el {{ ubicacion.created_at.strftime('%d/%m/%Y %H:%M') }}.</p>
    </div>
    <div>
        <form method="post" action="{{ url_for('renombrar_gaveta', nombre=ubicacion.nombre) }}" class="inline-form">
            <label for="nuevo_nombre">Cambiar nombre de la gaveta</label>
            <input type="text" id="nuevo_nombre" name="nuevo_nombre" value="{{ ubicacion.nombre }}" required />
            <button type="submit" class="button-link">Actualizar nombre</button>
        </form>
    </div>
    <div class="stat-card" style="width: 100%;">
        <span>Unidades registradas en esta ubicación</span>
        <strong>{{ total_unidades }}</strong>
        <p style="margin: 0; color: #57606f; font-size: 0.95rem;">
            Inventario histórico: {{ total_unidades_inventario }} · Asignaciones activas: {{ total_unidades_asignadas }}
        </p>
    </div>
</section>

<h3 class="section-title">Asignaciones activas por pedido</h3>
{% if asignaciones_gaveta %}
<div class="table-wrapper">
    <table>
        <thead>
            <tr>
                <th>Pedido</th>
                <th>Cliente</th>
                <th>Código</th>
                <th>Descripción</th>
                <th>Estado</th>
                <th>Unidades registradas</th>
            </tr>
        </thead>
        <tbody>
            {% for asignacion in asignaciones_gaveta %}
            <tr>
                <td>#{{ asignacion.pedido_id }}</td>
                <td>{{ asignacion.cliente }}</td>
                <td>{{ asignacion.codigo }}</td>
                <td>{{ asignacion.descripcion }}</td>
                <td>{{ asignacion.estado }}</td>
                <td>{{ asignacion.unidades }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="empty-state">Esta gaveta todavía no tiene asignaciones creadas desde la lectura de códigos.</div>
{% endif %}

<h3 class="section-title">Inventario registrado en esta ubicación</h3>
{% if articulos %}
<div class="table-wrapper">
    <table>
        <thead>
            <tr>
                <th>Código</th>
                <th>Nombre</th>
                <th>Cantidad</th>
            </tr>
        </thead>
        <tbody>
            {% for articulo in articulos %}
            <tr>
                <td>{{ articulo.codigo }}</td>
                <td>{{ articulo.nombre }}</td>
                <td>{{ articulo.cantidad }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="empty-state">No hay movimientos previos registrados manualmente en esta ubicación.</div>
{% endif %}
{% endblock %}
